<!DOCTYPE html>
<html>

<head>
    <title>AppStore</title>
    <meta charset="utf-8">
    
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular-animate.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular-sanitize.js"></script>
    <script src="//angular-ui.github.io/bootstrap/ui-bootstrap-tpls-2.5.0.js"></script>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    
<!--  
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.8/angular.min.js"></script>
    <script src="./ui-bootstrap-custom-tpls-2.5.0.min.js"></script>
    <script src="https://angular-ui.github.com/bootstrap/ui-bootstrap-tpls-0.1.0.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
-->
    <script>
        var app = angular.module('AppStore', ['ui.bootstrap']);

        function loadApps($scope, $http) {
            $http({
                method: 'GET',
                url: ('/apps')
            }).then(function(response) {
                $scope.apps = response.data;
            });
        }

        app.controller('AppStoreCtrl', function($scope, $http, $uibModal ) {

            loadApps($scope, $http);

            var addDialogOptions = {
                controller: 'AddAppCtrl',
                templateUrl: './appAdd.html'
            };

            $scope.add = function() {
                var modalInstance = $uibModal.open({
                templateUrl: './appAdd.html',
                controller: 'AddAppCtrl',
                });
                
                modalInstance.result.then(function(result){
                    loadApps($scope, $http);
                });
                    
            };

            var editDialogOptions = {
                controller: 'EditAppCtrl',
                templateUrl: './appEdit.html',
            };

            $scope.edit = function(app) {
                var appToEdit = app;
                
                var modalInstance = $uibModal.open({
                templateUrl: './appEdit.html',
                controller: 'EditAppCtrl',
                resolve: {
                        app: angular.copy(appToEdit)
                    }
                });
                
                modalInstance.result.then(function(result){
                    loadApps($scope, $http);
                });
                    
            };
            
            $scope.delete = function(app) {
                var deleteRequest = {
                    method: 'DELETE',
                    url: ('/apps/' + app.id)
                };

                $http(deleteRequest).then(function() {
                    loadApps($scope, $http);
                });
                //todo handle error
            };
        });


        app.controller('AddAppCtrl', function($scope, $http) {

            $scope.save = function() {
                var postRequest = {
                    method: 'POST',
                    url: ('/apps'),
                    data: {
                        text: $scope.app.text,
                        tags: $scope.app.tags,
                        title: $scope.app.title
                    }
                }

                $http(postRequest).then(function(response) {
                    $scope.apps = response.data;
                }).then(function() {
                    $scope.$close();
                });
            };

            $scope.close = function() {;
                $scope.$close();
            };
        });

        app.controller('EditAppCtrl', function($scope, $http, app) {

            $scope.app = app;
            $scope.save = function() {
                var putRequest = {
                    method: 'PUT',
                    url: ('/apps/' + $scope.app.id),
                    data: {
                        text: $scope.app.text,
                        tags: $scope.app.tags,
                        title: $scope.app.title
                    }
                }

                $http(putRequest).then(function(response) {
                    $scope.apps = response.data;
                }).then(function() {
                    //todo handle error
                    $scope.$close();
                });
            };

            $scope.close = function() {
                loadApps($scope, $http);
                $scope.$close();
            };
        });
    </script>
</head>

<body ng-app="AppStore">
    <div ng-controller="AppStoreCtrl">
        <h3>Apps@HM:</h3>
        <table class="mdl-data-table">
            <tr>
                <td class="mdl-data-table__cell--non-numeric" colspan=3>&nbsp;</td>
                <td class="mdl-data-table__cell--non-numeric"><button class="mdl-button" ng-click="add()">add App</button></td>
            </tr>
            <tr ng-repeat="app in apps">
                <td class="mdl-data-table__cell--non-numeric">{{app.title}}</td>
                <td class="mdl-data-table__cell--non-numeric">{{app.text}}</td>
                <td class="mdl-data-table__cell--non-numeric">{{app.tags}}</td>
                <td class="mdl-data-table__cell--non-numeric"><button class="mdl-button" ng-click="edit(app)">edit</button>
                    <button class="mdl-button" ng-click="delete(app)">delete</button></td>
            </tr>
        </table>
    </div>
</body>

</html>